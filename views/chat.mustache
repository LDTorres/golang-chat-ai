<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Icons
    const PlusIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>;
    const ChatIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" /></svg>;
    const UserIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>;
    const SendIcon = () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-4 h-4"><path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" /></svg>;
    const MenuIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg>;
    const TrashIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-4 h-4"><path strokeLinecap="round" strokeLinejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" /></svg>;
    const LogoutIcon = () => <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5"><path strokeLinecap="round" strokeLinejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" /></svg>;

    const Sidebar = ({ chats, currentChatId, onSelectChat, onNewChat, onDeleteChat, user, onLogout, isOpen, toggleSidebar }) => {
        return (
            <div className={`fixed md:relative z-30 h-screen bg-sidebar border-r border-border flex flex-col transition-all duration-300 ease-in-out 
                ${isOpen ? 'translate-x-0' : '-translate-x-full'} 
                md:translate-x-0 
                ${isOpen ? 'w-[260px] md:w-[260px]' : 'w-[260px] md:w-0 md:border-none md:overflow-hidden'}
            `}>
                <div className={`flex-col h-full ${!isOpen && 'md:hidden'}`}>
                    <div className="p-3 flex-shrink-0 flex items-center gap-2">
                        <button
                            onClick={onNewChat}
                            className="flex-1 flex items-center gap-3 px-3 py-3 rounded-lg border border-white/20 hover:bg-white/5 transition-colors text-primary text-sm text-left transition-all duration-200"
                        >
                            <PlusIcon />
                            <span className="font-medium">New chat</span>
                        </button>
                        <button
                            onClick={toggleSidebar}
                            className="md:flex p-3 rounded-lg border border-white/20 hover:bg-white/5 text-secondary hover:text-primary transition-colors"
                            title="Close sidebar"
                        >
                            <MenuIcon />
                        </button>
                    </div>

                    <div className="flex-1 overflow-y-auto overflow-x-hidden px-2">
                        <div className="flex flex-col gap-1">
                            <div className="text-xs font-medium text-secondary px-3 py-2">History</div>
                            {chats.map(chat => (
                                <div
                                    key={chat.ID}
                                    className={`flex items-center gap-2 relative rounded-lg cursor-pointer hover:bg-white/5 group transition-colors ${currentChatId === chat.ID ? 'bg-white/10' : ''}`}
                                >
                                    <button
                                        onClick={() => onSelectChat(chat.ID)}
                                        className="flex-1 flex py-3 px-3 items-center gap-3 overflow-hidden"
                                    >
                                        <ChatIcon />
                                        <div className="flex-1 text-ellipsis max-h-5 overflow-hidden break-all relative text-sm text-primary/90 text-left">
                                            {chat.title || "New Chat"}
                                        </div>
                                    </button>
                                    <button
                                        onClick={(e) => { e.stopPropagation(); onDeleteChat(chat.ID); }}
                                        className="p-2 text-secondary hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity"
                                        title="Delete chat"
                                    >
                                        <TrashIcon />
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="border-t border-border p-3">
                        <div className="flex items-center gap-3 rounded-lg hover:bg-white/5 cursor-pointer p-3 transition-colors group relative">
                            <div className="w-8 h-8 bg-accent rounded-full flex items-center justify-center text-white font-bold text-xs shadow-lg">
                                {user?.name?.charAt(0).toUpperCase()}
                            </div>
                            <div className="flex-1 min-w-0">
                                <div className="text-sm font-medium text-primary truncate">{user?.name}</div>
                                <div className="text-xs text-secondary truncate">{user?.email}</div>
                            </div>
                            <button
                                onClick={onLogout}
                                className="absolute right-2 p-2 text-secondary hover:text-primary bg-sidebar rounded-md opacity-0 group-hover:opacity-100 transition-opacity shadow-lg"
                                title="Logout"
                            >
                                <LogoutIcon />
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const ChatMessage = ({ message }) => {
        const isUser = message.role === 'user';
        return (
            <div className={`group w-full text-primary border-b border-black/5 dark:border-white/5 ${isUser ? 'bg-transparent' : 'bg-transparent'}`}>
                <div className="text-base gap-4 md:gap-6 md:max-w-3xl lg:max-w-[40rem] xl:max-w-[48rem] p-4 md:py-6 flex lg:px-0 m-auto">
                    <div className="w-[30px] flex flex-col relative items-end flex-shrink-0">
                        <div className={`relative h-8 w-8 rounded-sm flex items-center justify-center shadow-sm ${isUser ? 'bg-transparent' : 'bg-green-500/10'}`}>
                            {isUser ? (
                                <div className="w-8 h-8 bg-accent rounded-sm flex items-center justify-center text-white font-semibold text-xs">
                                    U
                                </div>
                            ) : (
                                <div className="w-8 h-8 bg-emerald-500 rounded-sm flex items-center justify-center text-white">
                                    <span className="text-xs font-bold">AI</span>
                                </div>
                            )}
                        </div>
                    </div>
                    <div className="relative flex-1 overflow-hidden">
                        <div className="font-semibold text-xs mb-1 opacity-90">{isUser ? 'You' : 'BoreDev AI'}</div>
                        <div className="prose prose-invert max-w-none leading-7 text-primary/90 whitespace-pre-wrap">
                            {message.content}
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const App = () => {
        const [user, setUser] = useState(null);
        const [chats, setChats] = useState([]);
        const [currentChatId, setCurrentChatId] = useState(null);
        const [messages, setMessages] = useState([]);
        const [input, setInput] = useState("");
        const [loading, setLoading] = useState(false);
        const [sidebarOpen, setSidebarOpen] = useState(true);
        const messagesEndRef = useRef(null);

        useEffect(() => {
            const userId = localStorage.getItem('user_id');
            const userName = localStorage.getItem('user_name');
            const userEmail = localStorage.getItem('user_email');

            if (!userId) {
                window.location.href = '/';
                return;
            }
            setUser({ ID: userId, name: userName, email: userEmail });
            fetchChats(userId);
        }, []);

        useEffect(() => {
            messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
        }, [messages]);

        const fetchChats = async (userId) => {
            try {
                const res = await fetch(`/api/v1/users/${userId}/chats`);
                const data = await res.json();
                setChats(data || []);
            } catch (err) {
                console.error("Failed to fetch chats", err);
            }
        };

        const loadChat = async (chatId) => {
            setCurrentChatId(chatId);
            setLoading(true);
            try {
                const res = await fetch(`/api/v1/chats/${chatId}/messages`);
                const data = await res.json();
                setMessages(data || []);
            } catch (err) {
                console.error("Failed to load messages", err);
            } finally {
                setLoading(false);
            }
        };

        const handleNewChat = () => {
            setCurrentChatId(null);
            setMessages([]);
            setInput("");
        };

        const handleDeleteChat = async (chatId) => {
            if (!confirm("Are you sure you want to delete this chat?")) return;

            try {
                const res = await fetch(`/api/v1/chats/${chatId}`, { method: 'DELETE' });
                if (res.ok) {
                    setChats(chats.filter(c => c.ID !== chatId));
                    if (currentChatId === chatId) {
                        handleNewChat();
                    }
                } else {
                    alert("Failed to delete chat");
                }
            } catch (e) {
                console.error(e);
                alert("Error deleting chat");
            }
        };

        const handleLogout = () => {
            localStorage.clear();
            window.location.href = '/';
        };

        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!input.trim() || loading) return;

            const userMessage = input.trim();
            setInput("");

            // Optimistic update
            const tempMessages = [...messages, { role: 'user', content: userMessage }];
            setMessages(tempMessages);
            setLoading(true);

            try {
                let res;
                if (!currentChatId) {
                    // Create new chat
                    res = await fetch('/api/v1/chats', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: parseInt(user.ID), message: userMessage })
                    });
                } else {
                    // Send message
                    res = await fetch(`/api/v1/chats/${currentChatId}/messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: userMessage })
                    });
                }

                const data = await res.json();

                if (res.ok) {
                    if (!currentChatId) {
                        setCurrentChatId(data.chat.ID);
                        setChats([data.chat, ...chats]);
                        setMessages([...tempMessages, data.response]);
                    } else {
                        setMessages([...tempMessages, data]);
                    }
                } else {
                    alert(data.error || "Error sending message");
                }
            } catch (err) {
                console.error(err);
                alert("Failed to send message");
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="flex h-screen overflow-hidden bg-main">
                <Sidebar
                    chats={chats}
                    currentChatId={currentChatId}
                    onSelectChat={loadChat}
                    onNewChat={handleNewChat}
                    onDeleteChat={handleDeleteChat}
                    user={user}
                    onLogout={handleLogout}
                    isOpen={sidebarOpen}
                    toggleSidebar={() => setSidebarOpen(!sidebarOpen)}
                />

                <div className="flex-1 flex flex-col h-screen relative">
                    {/* Desktop Sidebar Toggle */}
                    <div className={`hidden md:flex absolute top-2 left-2 z-20 transition-opacity duration-300 ${sidebarOpen ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                        <button
                            onClick={() => setSidebarOpen(true)}
                            className="p-2 rounded-md text-secondary hover:text-primary bg-main/80 backdrop-blur-sm border border-white/10 shadow-sm hover:bg-white/5 transition-all"
                            title="Open sidebar"
                        >
                            <MenuIcon />
                        </button>
                    </div>

                    {/* Mobile Header / Sidebar Toggle */}
                    <div className="sticky top-0 z-10 flex items-center p-2 text-secondary bg-main border-b border-border md:hidden">
                        <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-2 -ml-2 rounded-md hover:text-primary focus:outline-none">
                            <MenuIcon />
                        </button>
                        <div className="flex-1 text-center text-base font-medium text-primary">
                            {currentChatId ? (chats.find(c => c.ID === currentChatId)?.title || 'Chat') : 'New Chat'}
                        </div>
                    </div>

                    {/* Chat Area */}
                    <div className="flex-1 overflow-y-auto scroll-smooth">
                        {messages.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-screen text-primary px-4">
                                <div className="bg-white/5 p-4 rounded-xl mb-6 shadow-2xl ring-1 ring-white/10">
                                    <div className="text-4xl">ðŸ¤–</div>
                                </div>
                                <h1 className="text-2xl font-semibold mb-2">BoreDev AI</h1>
                                <p className="text-secondary mb-8 text-center max-w-md">Your personal AI assistant. Ask me anything!</p>

                                <div className="grid gap-3 w-full max-w-2xl sm:grid-cols-2">
                                    <button onClick={() => setInput("Explain quantum computing")} className="p-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 text-left transition-all hover:scale-[1.02]">
                                        <div className="font-medium mb-1">Explain quantum computing</div>
                                        <div className="text-xs text-secondary">in simple terms</div>
                                    </button>
                                    <button onClick={() => setInput("Write a Python script")} className="p-4 rounded-xl bg-white/5 hover:bg-white/10 border border-white/5 text-left transition-all hover:scale-[1.02]">
                                        <div className="font-medium mb-1">Write a Python script</div>
                                        <div className="text-xs text-secondary">to parse JSON data</div>
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <div className="flex flex-col pb-40 pt-4">
                                {messages.map((msg, idx) => (
                                    <ChatMessage key={idx} message={msg} />
                                ))}
                                {loading && (
                                    <div className="w-full py-4 flex items-center justify-center text-secondary">
                                        <div className="flex items-center gap-2">
                                            <div className="w-2 h-2 bg-accent rounded-full animate-bounce"></div>
                                            <div className="w-2 h-2 bg-accent rounded-full animate-bounce delay-75"></div>
                                            <div className="w-2 h-2 bg-accent rounded-full animate-bounce delay-150"></div>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                        )}
                    </div>

                    {/* Input Area */}
                    <div className="absolute bottom-0 left-0 w-full bg-gradient-to-t from-main via-main to-transparent pt-10 pb-6 px-4">
                        <div className="mx-auto max-w-3xl">
                            <form onSubmit={handleSubmit} className="relative flex items-end gap-2 bg-input border border-white/10 rounded-xl shadow-2xl ring-1 ring-black/5 focus-within:ring-2 focus-within:ring-accent/50 transition-all">
                                <input
                                    type="text"
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    placeholder="Send a message..."
                                    className="w-full max-h-[200px] py-4 pl-4 pr-12 bg-transparent border-0 focus:ring-0 text-primary placeholder-secondary resize-none"
                                    disabled={loading}
                                    maxLength={300}
                                />
                                <button
                                    type="submit"
                                    disabled={!input.trim() || loading}
                                    className="absolute right-2 bottom-2 p-2 rounded-lg text-white bg-accent hover:bg-accent-hover disabled:bg-transparent disabled:text-secondary transition-colors"
                                >
                                    <SendIcon />
                                </button>
                            </form>
                            <div className="text-center text-xs text-secondary mt-2">
                                BoreDev AI can make mistakes. Consider checking important information.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>